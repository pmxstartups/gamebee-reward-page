<body>
  <canvas id="confetti-canvas"></canvas>
  <div class="card" id="reward-card">
    <h2 id="title">ğŸ‰ Gamebee Scratch & Win!</h2>

    <!-- Reward initially hidden -->
    <div id="reward" class="reward" style="display:none;"></div>

    <!-- Step 1: Scratch Button -->
    <button class="btn" id="scratch-btn">Scratch Now ğŸ¯</button>

    <!-- Step 2: Countdown before reveal -->
    <p id="countdown" class="message" style="display:none; color:#000;"></p>

    <!-- Step 3: WhatsApp Share button (hidden at start) -->
    <a href="#" class="btn" id="btn" style="display:none;">Share on WhatsApp</a>

    <p id="message" class="message">Screenshot and send it to us ğŸ“¸</p>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";
    import { getAnalytics, isSupported } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-analytics.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBRhAVD_SQAKaMKIOiEynhMnQsg0acp4z0",
      authDomain: "game-bee-reward.firebaseapp.com",
      projectId: "game-bee-reward",
      storageBucket: "game-bee-reward.firebasestorage.app",
      messagingSenderId: "106940026019",
      appId: "1:106940026019:web:b33b6c6ee0c15b4482c316",
      measurementId: "G-XYJS3XKYGD"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    (async () => {
      if (await isSupported()) getAnalytics(app);
    })();

    const fpPromise = FingerprintJS.load();

    document.getElementById('scratch-btn').addEventListener('click', async () => {
      const fp = await fpPromise;
      const result = await fp.get();
      const visitorId = result.visitorId;

      const docRef = doc(db, "scratch_claims", visitorId);
      const docSnap = await getDoc(docRef);

      const rewardText = document.getElementById('reward');
      const titleText = document.getElementById('title');
      const messageText = document.getElementById('message');
      const button = document.getElementById('btn');
      const scratchBtn = document.getElementById('scratch-btn');
      const countdown = document.getElementById('countdown');

      if (docSnap.exists()) {
        // Already played
        rewardText.textContent = '';
        button.style.display = 'none';
        scratchBtn.style.display = 'none';
        titleText.textContent = 'ğŸ‘€ One Time Only!';
        messageText.textContent = 'Sorry, you can scratch only once per week!';
      } else {
        // Start suspense countdown
        scratchBtn.style.display = 'none';
        countdown.style.display = 'block';

        let timer = 3;
        countdown.textContent = `â³ Revealing in ${timer}...`;

        const interval = setInterval(() => {
          timer--;
          countdown.textContent = `â³ Revealing in ${timer}...`;
          if (timer === 0) {
            clearInterval(interval);
            countdown.style.display = 'none';

            // Reveal reward
            const offers = [
              "ğŸ® Free PS5 extension for half day",
              "ğŸ”¥ 10% OFF your next booking",
              "â­ Free Payasam",
              "ğŸ Free Extra Controller",
              "âš¡ Free Game Enjoy",
              "ğŸ’¸ Rs 100 OFF on current booking"
            ];
            const selected = offers[Math.floor(Math.random() * offers.length)];
            rewardText.textContent = selected;
            rewardText.style.display = 'block';

            const message = encodeURIComponent(
              `ğŸ‰ I just won "${selected}" in Gamebee's Scratch & Win! ğŸ•¹ï¸ğŸ”¥`
            );
            button.setAttribute('href', `https://wa.me/918139095325?text=${message}`);
            button.style.display = 'inline-block';

            // Save claim
            setDoc(docRef, {
              reward: selected,
              timestamp: new Date().toISOString()
            });

            // Fire confetti
            confetti({
              particleCount: 120,
              spread: 80,
              origin: { y: 0.6 },
              colors: ['#ffca28', '#000000', '#ffc107', '#fdd835']
            });
          }
        }, 1000);
      }
    });
  </script>
</body>
